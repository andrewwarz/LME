<!DOCTYPE html>
<html lang="en">
    <head> 
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Certificates</title>
        <meta property="og:title" content="LME">
        <meta property="og:locale" content="en_US">
        <meta name="description" content="Logging Made Easy - CISA's open source platform for centralized log collection and threat detection">
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link rel="stylesheet" href="assets/css/style.css">
        <link rel="icon" href="assets/imgs/favicon.png">
    </head>

    <body>
        <div class="wrapper">
            <header>
                <div class="side-nav">
                    <img class="logo" src="assets/imgs/lme-image.png" alt="Logging Made Easy Logo">
                    <div class="version">v2.0</div>
                    <div class="nav-links">

                        <a href="\docs\index.html"><i class="fas fa-info-circle"></i> About</a>
                        <a href="installation-overview.html"><i class="fas fa-download"></i> Installation</a>
                        <a  class="active" href="documentation.html"><i class="fas fa-book"></i> Documentation</a>
                    </div>
                </div>
                <div class="nav-footer">
                    <a class="foot-link" href="https://github.com/cisagov/LME">LME on GitHub</a>
                    <a class="foot-link" href="https://www.cisa.gov/resources-tools/services/logging-made-easy">CISA</a>
                    <a class="foot-link" href="mailto:CyberSharedServices@cisa.dhs.gov">Contact Us</a>
                </div>
            </header>
        <main>
            <div class="top-search-container">
                <div class="search-box">
                  <input type="text" id="searchInput" placeholder="Search">
                  <button id="searchButton"><i class="fas fa-search"></i></button>
                </div>
                <div id="searchResults" class="search-results"></div>
            </div>
            <section>
                <div class="body-text">

                    <h1 id="certificates">Certificates</h1>
                    <p>The LME installation makes use of a number of TLS certificates to protect communications between the server components and agents, and also secures the connections between Elasticsearch and Kibana. 
                    By default the installation will create certificates and this documentation describes how to modify and update the cert store.</p>
                    <h2 id="regenerating-self-signed-certificates">Regenerating Self-Signed Certificates</h2>
                    <p>The easiest way to do this is to delete the <code class="inline">lme_certs</code> volume, and restart lme.service:</p>
                    <p>This is destructive and not recommended, but there could be cases.</p>
                    <pre><code class="lang-bash">sudo -i podman <span class="hljs-keyword">volume</span><span class="bash"> rm lme_certs
                    </span>sudo systemctl restart lme.service
                    </code></pre>
                    <h2 id="using-your-own-certificates">Using Your Own Certificates</h2>
                    <p>You can use certificates signed by an existing root CA as part of the LME install by generating certificates manually with the correct settings and placing these within the required directory inside the LME folder.</p>
                    <p><strong>NOTE: The default supported method of LME installation is to use the automatically created self-signed certificates, and we will be unable to support any problems that arise from generating the certificates manually incorrectly.</strong></p>
                    <h3 id="certificate-creation">Certificate Creation</h3>
                    <p>If you create certificates ensure their subject alt names allow for the ips/dns entries listed below, as well as the ips/domains you&#39;ll be connecting to the service as: </p>
                    <pre><code class="lang-bash">root@ubuntu:~# cat /opt/lme/config/setup/instances.yml  | head -n 30
                    # Add host IP address / domain names as needed.
                    
                    instances:
                      -<span class="ruby"> <span class="hljs-symbol">name:</span> <span class="hljs-string">"elasticsearch"</span>
                    </span>    dns:
                          -<span class="ruby"> <span class="hljs-string">"lme-elasticsearch"</span>
                    </span>      -<span class="ruby"> <span class="hljs-string">"localhost"</span>
                    </span>    ip:
                          -<span class="ruby"> <span class="hljs-string">"127.0.0.1"</span>
                    </span>
                      -<span class="ruby"> <span class="hljs-symbol">name:</span> <span class="hljs-string">"kibana"</span>
                    </span>    dns:
                          -<span class="ruby"> <span class="hljs-string">"lme-kibana"</span>
                    </span>      -<span class="ruby"> <span class="hljs-string">"localhost"</span>
                    </span>    ip:
                          -<span class="ruby"> <span class="hljs-string">"127.0.0.1"</span>
                    </span>
                      -<span class="ruby"> <span class="hljs-symbol">name:</span> <span class="hljs-string">"fleet-server"</span>
                    </span>    dns:
                          -<span class="ruby"> <span class="hljs-string">"lme-fleet-server"</span>
                    </span>      -<span class="ruby"> <span class="hljs-string">"localhost"</span>
                    </span>    ip:
                          -<span class="ruby"> <span class="hljs-string">"127.0.0.1"</span>
                    </span>
                      -<span class="ruby"> <span class="hljs-symbol">name:</span> <span class="hljs-string">"wazuh-manager"</span>
                    </span>    dns:
                          -<span class="ruby"> <span class="hljs-string">"lme-wazuh-manager"</span>
                    </span>      -<span class="ruby"> <span class="hljs-string">"localhost"</span>
                    </span>    ip:
                          -<span class="ruby"> <span class="hljs-string">"127.0.0.1"</span></span>
                    </code></pre>
                    <p>For example, the new kibana cert would need to support the above alternative names. You can also ensure its setup properly by viewing the current cert (assuming you&#39;ve already mounted the <code class="inline">lme_certs</code> podman volume).</p>
                    <pre><code class="lang-bash">root@<span class="hljs-symbol">ubuntu:</span>~$ cat /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">containers</span>/<span class="hljs-title">storage</span>/<span class="hljs-title">volumes</span>/<span class="hljs-title">lme_certs</span>/<span class="hljs-title">_data</span>/<span class="hljs-title">kibana</span>/<span class="hljs-title">kibana</span>.<span class="hljs-title">crt</span>  | <span class="hljs-title">openssl</span> <span class="hljs-title">x509</span> -<span class="hljs-title">text</span> | <span class="hljs-title">grep</span> -<span class="hljs-title">i</span> <span class="hljs-title">Alternative</span> -<span class="hljs-title">A</span> 1</span>
                                X509v3 Subject Alternative <span class="hljs-symbol">Name:</span>
                                    <span class="hljs-symbol">DNS:</span>lme-kibana, IP <span class="hljs-symbol">Address:</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>, <span class="hljs-symbol">DNS:</span>localhost
                    </code></pre>
                    <h3 id="certificate-locations">Certificate Locations</h3>
                    <p>All the certs are stored in the lme_certs volume. Here is how to list/change/modify the contents:</p>
                    <pre><code class="lang-bash">root@ubuntu:$ podman volume mount lme_certs
                    /var/lib/containers/storage/volumes/lme_certs/_data
                    root@ubuntu:$ cd /var/lib/containers/storage/volumes/lme_certs/_data/
                    root@ubuntu:/var/lib/containers/storage/volumes/lme_certs/_data$ tree
                    .
                    ├── ACCOUNTS_CREATED
                    ├── ca
                    │   ├── ca<span class="hljs-selector-class">.crt</span>
                    │   └── ca<span class="hljs-selector-class">.key</span>
                    ├── ca<span class="hljs-selector-class">.zip</span>
                    ├── caddy
                    │   ├── caddy<span class="hljs-selector-class">.crt</span>
                    │   └── caddy<span class="hljs-selector-class">.key</span>
                    ├── certs<span class="hljs-selector-class">.zip</span>
                    ├── curator
                    │   ├── curator<span class="hljs-selector-class">.crt</span>
                    │   └── curator<span class="hljs-selector-class">.key</span>
                    ├── elasticsearch
                    │   ├── elasticsearch<span class="hljs-selector-class">.chain</span><span class="hljs-selector-class">.pem</span>
                    │   ├── elasticsearch<span class="hljs-selector-class">.crt</span>
                    │   └── elasticsearch<span class="hljs-selector-class">.key</span>
                    ├── fleet-server
                    │   ├── fleet-server<span class="hljs-selector-class">.crt</span>
                    │   └── fleet-server<span class="hljs-selector-class">.key</span>
                    ├── kibana
                    │   ├── kibana<span class="hljs-selector-class">.crt</span>
                    │   └── kibana<span class="hljs-selector-class">.key</span>
                    ├── logstash
                    │   ├── logstash<span class="hljs-selector-class">.crt</span>
                    │   └── logstash<span class="hljs-selector-class">.key</span>
                    └── wazuh-manager
                        ├── wazuh-manager<span class="hljs-selector-class">.crt</span>
                            └── wazuh-manager.key
                    </code></pre>
                    <p>To edit the certs/replace the certs, copy the new desired certificate and key to the above location on the disk: </p>
                    <pre><code>cp ~<span class="hljs-regexp">/new_kibana_cert.crt /var</span><span class="hljs-regexp">/lib/containers</span><span class="hljs-regexp">/storage/volumes</span><span class="hljs-regexp">/lme_certs/</span>_data/kibana.crt
                    cp ~<span class="hljs-regexp">/new_kibana_key.key /var</span><span class="hljs-regexp">/lib/containers</span><span class="hljs-regexp">/storage/volumes</span><span class="hljs-regexp">/lme_certs/</span>_data/kibana.key
                    </code></pre><h2 id="migrating-from-self-signed-certificates">Migrating from Self-Signed Certificates</h2>
                    <p>You can migrate from the default self-signed certificates to manually generated certificates at a later date, for example to move to enterprise certificates post-installation after an initial testing period. </p>
                    <p><strong>NOTE: The default supported method of LME installation is to use the automatically created self-signed certificates, and we will be unable to support any problems that arise from generating the certificates manually incorrectly.</strong></p>
                    <p>Simply replace the certs above within the given container for the given service that you would like LME to use. If the certs are signed, ensure you also include the root ca in the  appropriate location as well.</p>
            
                </div>
            </section>
            <div class="page-navigation">
                <!-- [TODO] INSERT ROUTING FOR PREVIOUS PAGE IF APPLICABLE, ADD "disabled" CLASS IF NOT -->
                <a href="backups.html" class="nav-button prev-button">
                    <i class="fas fa-arrow-left"></i>
                    <span>Backups</span>
                </a>
                 <!-- [TODO] INSERT ROUTING FOR PREVIOUS PAGE IF APPLICABLE, ADD "disabled" CLASS IF NOT -->
                <a href="encryption-at-rest.html" class="nav-button next-button">
                    <span>Encryption at Rest</span>
                    <i class="fas fa-arrow-right"></i>
                </a>
            </div>
        </main>
    </div>
    <script src="assets/js/copy-code.js"></script>
    <script src="assets/js/search-bar.js"></script>
</body>

</html>